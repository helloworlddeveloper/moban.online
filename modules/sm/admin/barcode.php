<?php/** * @Project NUKEVIET 4.x * @Author Mr.Thang <contact@vinades.vn> * @Copyright (C) 2010 - 2014 Mr.Thang. All rights reserved * @License GNU/GPL version 2 or any later version * @Createdate Sun, 08 Apr 2012 00:00:00 GMT */if( !defined( 'NV_IS_FILE_ADMIN' ) ){    die( 'Stop!!!' );}// change statusif ($nv_Request->isset_request('change_status', 'post, get')) {    $id = $nv_Request->get_int('id', 'post, get', 0);    $content = 'NO_' . $id;    $query = 'SELECT status FROM ' . NV_PREFIXLANG . '_' . $module_data . '_barcode WHERE id=' . $id;    $row = $db->query($query)->fetch();    if (isset($row['status'])) {        $status = ($row['status']) ? 0 : 1;        $query = 'UPDATE ' . NV_PREFIXLANG . '_' . $module_data . '_barcode SET status=' . intval($status) . ' WHERE id=' . $id;        $db->query($query);        $content = 'OK_' . $id;    }    $nv_Cache->delMod($module_name);    include NV_ROOTDIR . '/includes/header.php';    echo $content;    include NV_ROOTDIR . '/includes/footer.php';    exit();}elseif( $nv_Request->isset_request( 'delete_id', 'get' ) and $nv_Request->isset_request( 'delete_checkss', 'get' ) ){    //cho admin toi cao moi xoa dc    if ( defined( 'NV_IS_GODADMIN' ) ) {        $id = $nv_Request->get_int( 'delete_id', 'get' );        $delete_checkss = $nv_Request->get_string( 'delete_checkss', 'get' );        $sql = 'SELECT catid FROM ' . NV_PREFIXLANG . '_' . $module_data . '_barcode WHERE id=' . $id;        list($catid_delete) = $db->query( $sql )->fetch(3);        //die($id . ":" . $catid_delete . ":" . $delete_checkss . ":". md5( $id . NV_CACHE_PREFIX . $client_info['session_id']));        if( $id > 0 and $catid_delete > 0 and $delete_checkss == md5( $id . NV_CACHE_PREFIX . $client_info['session_id'] ) )        {            $sql = 'DELETE FROM ' . NV_PREFIXLANG . '_' . $module_data . '_barcode  WHERE id = ' . $id;            $db->query($sql);            $nv_Cache->delMod( $module_name );            Header( 'Location: ' . NV_BASE_ADMINURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&' . NV_NAME_VARIABLE . '=' . $module_name . '&' . NV_OP_VARIABLE . '=' . $op );            die();        }    }}$per_page = 20;//$nv_Request->get_int( 'per_page', 'get', 10 );$q = $nv_Request->get_title( 'q', 'get', '' );$p = $nv_Request->get_title( 'p', 'get', '' );$sstatus = $nv_Request->get_int( 'sstatus', 'get', -1 );$producttype = $nv_Request->get_int( 'producttype', 'get', 0 );// = $nv_Request->get_int( 'num_items', 'get', 0 );$page = $nv_Request->get_int( 'page', 'get', 1 );$checkss = $nv_Request->get_string( 'checkss', 'get', '' );$array_status_view = array(    '-' => '---' . $lang_module['search_status'] . '---',    '1' => "Đã sử dụng",    '0' => "Chưa sử dụng");$base_url = NV_BASE_ADMINURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=' . $op;$sql_where = '';if( $producttype == 1 or $producttype == 2 ) {    $sql_where .= " and (t1.proid > 0 or t1.catid > 0)";    $where .= " and (t1.proid > 0 or t1.catid > 0)";    $base_url .= '&amp;producttype=' . $producttype;}if( $sstatus != -1 ) {    $sql_where .= ' and t1.status = ' . $sstatus;    $where .= ' and t1.status = ' . $sstatus;    $base_url .= '&amp;sstatus=' . $sstatus;}if( !empty( $q ) ) {    $sql_where .= " and t1.barcode = '" . $q . "'" ;    $where .= " and t1.barcode = '" . $q . "'" ;    $base_url .= '&amp;q=' . $q;}if( !empty( $p ) ) {    $sql_where .= " and (t3.phone = '" . $p . "' or t2.fullname like '%" . $p . "%')" ;    $base_url .= '&amp;p=' . $p;}$sql = 'SELECT count(*)         FROM ' . NV_PREFIXLANG . '_' . $module_data . '_barcode t1                         WHERE (1=1)' . $where;$num_items = $db->query($sql)->fetchColumn();$generate_page = nv_generate_page( $base_url, $num_items, $per_page, $page );$sql = 'SELECT t1.*, concat(t3.first_name, " ", t3.last_name) as fullname, t3.phone, ifnull(t2.customer_id,0) as customer_id, t3.userid         FROM ' . NV_PREFIXLANG . '_' . $module_data . '_barcode t1                 LEFT OUTER JOIN nv4_users t3 ON t1.customerid = t3.userid                   LEFT OUTER JOIN ' . NV_PREFIXLANG . '_' . $module_data . '_customer t2 ON t3.userid = t2.refer_userid                                WHERE (1=1)' . $sql_where;$sql .= ' LIMIT ' . $per_page . ' OFFSET ' . (( $page - 1 ) * $per_page );$xtpl = new XTemplate( $op . '.tpl', NV_ROOTDIR . '/themes/' . $global_config['module_theme'] . '/modules/' . $module_file );$xtpl->assign( 'LANG', $lang_module );$xtpl->assign( 'GLANG', $lang_global );$xtpl->assign( 'NV_BASE_ADMINURL', NV_BASE_ADMINURL );$xtpl->assign( 'NV_NAME_VARIABLE', NV_NAME_VARIABLE );$xtpl->assign( 'MODULE_NAME', $module_name );$xtpl->assign( 'OP', $op );$xtpl->assign( 'Q', $q );$xtpl->assign( 'P', $p );//echo $sql;die();$result = $db->query($sql);$i=0;while( $row = $result->fetch() ){    if ($row['status'] == 1) {        $check = 'checked disabled';        $row['link_edit'] = '#';    } else {        $check = '';        $row['link_edit'] = NV_BASE_ADMINURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=addbarcode&id=' . $row['id'];    }    $xtpl->assign('CHECK', $check);    $row['STT'] = ++$i;    $row['customer'] = $row['fullname'] . (empty($row['phone']) ? '' : ' [SĐT: ' . $row['phone'] . ']');    $row['created_date'] = nv_date( 'd/m/y', $row['created_date'] );    $row['used_date'] = !empty($row['used_date']) ? nv_date( 'd/m/y', $row['used_date'] ) : '';    $row['link_customer'] = NV_BASE_ADMINURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=customer_gifts&id=' . $row['customer_id'] . '&uid=' . $row['userid'];    $row['link_delete'] = NV_BASE_ADMINURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name . '&amp;' . NV_OP_VARIABLE . '=' . $op . '&amp;delete_id=' . $row['id'] . '&amp;delete_checkss=' . md5( $row['id'] . NV_CACHE_PREFIX . $client_info['session_id'] );    $xtpl->assign( 'ROW', $row );    $xtpl->parse( 'main.loop' );}foreach ( $array_select_gencodetype as $key => $value ){    $sl = ( $producttype == $key )? ' selected=selected' : '';    $xtpl->assign('PRODUCTTYPE', array('key' => $key, 'value' => $value, 'sl' => $sl));    $xtpl->parse('main.producttype');}$array_status = array( '0' => "Chưa sử dụng", '1' => "Đã sử dụng" );foreach( $array_status as $key => $_status ) {    $sl = ( $key == $sstatus ) ? ' selected="selected"' : '';    $xtpl->assign( 'SEARCH_STATUS', array(        'selected' => $sl,        'key' => $key,        'value' => $_status ) );    $xtpl->parse( 'main.search_status' );}if( !empty( $generate_page ) ) {    $xtpl->assign( 'NV_GENERATE_PAGE', $generate_page );    $xtpl->parse( 'main.generate_page' );}$xtpl->parse( 'main' );$contents = $xtpl->text( 'main' );$page_title = "Tra cứu mã thẻ cào";include NV_ROOTDIR . '/includes/header.php';echo nv_admin_theme( $contents );include NV_ROOTDIR . '/includes/footer.php';